---
title: "UKB_Instance0_Case_Extractor"
author: "Jonathan Chan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tictoc)
library(ggrepel)
library(ggsignif)
library(car)
rm(list=ls())

theme_set(theme_classic())

date <- as.POSIXlt(Sys.time(), 'UTC')
date <- strftime(date, "%Y%m%dT%H:%M:%S%z")
date <- str_match(date,'^(\\d+)T')[,2]
```

This script takes in the .tsv file from JupyterLab of all cases (via self-reported; hospital diagnoses; death cause record) for a certain disease and extracts out only those IDs which were

1. Diagnosed in hospital via ICD10/9 code at the date of attending assessment centre (instance 0) or beforehand
2. Self-reported at verbal interview at date of attending assessment centre (instance 0)

These .tsv files contain the following fields

- Hospital diagnosis ICD9/10 codes 
- Date of hospitaldiagnosis

- Self-reported non-cancer illness codes (p20002)
- Interpolated year of first diagnosis of each code (p20008)

## Import

```{r}
hcm_diag_tb <- read_tsv('ukb_HCM_20240209_icd10_icd9_selfrep_diagdates.tsv') #787 total cases
hf_diag_tb <- read_tsv('ukb_HF_20240209_icd10_icd9_selfrep_diagdates.tsv')#21437 total cases
t2d_diag_tb <- read_tsv('ukb_T2D_20240209_icd10_icd9_selfrep_diagdates.tsv') #47094 total cases
```

```{r}
attendance_date <- read_tsv('../../../../../../HCM_Severity/DATASETS/UKB/RAP/Outcomes/Processed/allukb_outcome_dates.tsv') %>%
  select(ID, contains('attend'))
```
## Filter Self-Reported Individuals

This filters for individuals who have self-reported disease and provides their interpolated age for first diagnosis of the disease.

```{r}
#Function to find the column number matching operation of interest for each row in tibble
find_column <- function(tbl_row, value, starter_field='p20002', outer_field='p20008') { #Starter field refers to the columns you look for in and outer_field refers to the columns you want to extract data from later
  
  output <- vector('character', ncol(tbl_row))
  
  for (i in seq_along(colnames(tbl_row))){ #For each column in the row
    if (isTRUE(str_detect(tbl_row[colnames(tbl_row)[i]],value))){ #If it detects the same string in that value
        output[[i]] <- colnames(tbl_row)[i]
    } else{
      output[[i]] <- NA
  }}
  
  output <- output[!is.na(output)]
  
  if (length(output) ==0){
    output <- NA
  } else if (length(output) >1){#i.e multiple instances, take the first instance
    output <- output[1]
  } 
  
  output <- str_replace(output, starter_field,outer_field) #Allows you to extract the interpolated age at first diagnosis easily
  return(output)
}

#This function extracts the IDs of individuals who have self-reported and returns their interpolated year of first diagnosis
selfreported_extractor <- function(og_tb, diagnosis_code, disease_name){
  
  selfrep <- select(og_tb, eid,
                    contains('p20002'),
                    contains('p20008'))
  
  selfrep_codes <- select(selfrep, contains('p20002'))
  selfrep_dates <- select(selfrep, contains('p20008'))
  
  #Extract the columns which have the value/diagnosis code of interest for each row/patient
  cols <- vector('list', nrow(selfrep))
  for (i in seq(length(cols))){ #For each row
    cols[[i]] <- find_column(selfrep_codes[i,], diagnosis_code)
  }
  
  print(str_c('There are',sum(!is.na(cols)), 'individuals who provide selfreported diagnosis of', diagnosis_code, sep=' '))
  
  #Retrieve the interpolated age for each patient
  selfrep_year <- vector('list', nrow(selfrep))
  for (i in seq(length(selfrep_year))){
    selfrep_year[[i]] <- ifelse(is.na(cols[[i]]),NA,selfrep_dates[i,cols[[i]]])
  }
  
  output_tb <- bind_cols(ID=selfrep$eid,selfrep_year=unlist(selfrep_year)) %>% #Assume row order is the same
    mutate(selfrep_year = ifelse(selfrep_year==-1, NA, selfrep_year)) %>%
    mutate(selfrep_year = as_date(date_decimal(selfrep_year))) 

  colnames(output_tb)<- c('ID',str_c('selfrep_',disease_name,'_interpolated_year'))
  return(output_tb)

}
```

```{r}
hcm_selfrep <- selfreported_extractor(hcm_diag_tb, 'hypertrophic cardiomyopathy','hcm')
hf_selfrep <- selfreported_extractor(hf_diag_tb, 'heart failure','hf')
t2d_selfrep <- selfreported_extractor(t2d_diag_tb, 'type 2 diabetes','t2d')
```

## Filter Hospital ICD10

This filters for individuals who have hospital diagnoses of ICD9/10 and returns their date of diagnosis.

```{r}
#This function extracts the IDs of individuals who have hospital diagnosis of disease and returns the date of diagnosis.
icd10_9_extractor <- function(og_tb, icd10_code, icd9_code,disease_name){
  
  #For ICD10
  icd10 <- select(og_tb, eid,
                    contains('p41270'),
                    contains('p41280'))
  
  icd10_codes <- icd10 %>% mutate(extract = str_split(p41270,", \\'")) %>% select(extract) #Forms a list column called extract
  icd10_dates <- select(icd10, contains('p41280'))
  
  #Extract the columns which have the value/diagnosis code of interest for each row/patient, outputting as array index
  icd10_cols <- vector('list', nrow(icd10))
  for (i in seq(length(icd10_cols))){ #For each row
    icd10_cols[[i]] <- which(str_detect(icd10_codes$extract[[i]],icd10_code))
    
    if (length(icd10_cols[[i]] > 1)){
      icd10_cols[[i]] <- min(icd10_cols[[i]]) #Take the earlier array value if multiple matches
    }
  }
  
  print(str_c('There are',length(unlist(icd10_cols)), 'individuals who provide hospital ICD10 diagnosis of', disease_name, sep=' '))
  
  #Retrieve the date of hospital diagnosis for each patient
  icd10_diagdate <- vector('list', nrow(icd10))
  for (i in seq(length(icd10_diagdate))){
    icd10_diagdate[[i]] <- ifelse(length(icd10_cols[[i]])==0,NA,icd10_dates[i,icd10_cols[[i]]])
  }
  
  #For ICD9
  
  icd9 <- select(og_tb, eid,
                    contains('p41271'),
                    contains('p41281'))
  
  icd9_codes <- icd9 %>% mutate(extract = str_split(p41271,", \\'")) %>% select(extract) #Forms a list column called extract
  icd9_dates <- select(icd9, contains('p41281'))
  
  #Extract the columns which have the value/diagnosis code of interest for each row/patient, outputting as array index
  icd9_cols <- vector('list', nrow(icd9))
  for (i in seq(length(icd9_cols))){ #For each row
    icd9_cols[[i]] <- which(str_detect(icd9_codes$extract[[i]],icd9_code))
    
     if (length(icd9_cols[[i]] > 1)){
      icd9_cols[[i]] <- min(icd9_cols[[i]]) #Take the earlier array value if multiple matches
    }
  }
  
  print(str_c('There are',length(unlist(icd9_cols)), 'individuals who provide hospital ICD9 diagnosis of', disease_name, sep=' '))
  
  #Retrieve the date of hospital diagnosis for each patient
  icd9_diagdate <- vector('list', nrow(icd9))
  for (i in seq(length(icd9_diagdate))){
    icd9_diagdate[[i]] <- ifelse(length(icd9_cols[[i]])==0,NA,icd9_dates[i,icd9_cols[[i]]])
  }
  
  #Output the output_tb
  
  output_tb <- bind_cols(ID=icd10$eid,icd10_diagdate=unlist(icd10_diagdate),icd9_diagdate=unlist(icd9_diagdate)) %>%  #Assume row order is the same
    mutate(icd10_diagdate=as_date(icd10_diagdate),
           icd9_diagdate=as_date(icd9_diagdate))

  colnames(output_tb)<- c('ID',str_c('icd10_',disease_name,'diagdate'),str_c('icd9_',disease_name,'diagdate'))
  
  return(output_tb)
}
```


```{r}
hcm_hospdiag <- icd10_9_extractor(hcm_diag_tb, 'I42.1|I42.2','4251', 'hcm')
hf_hospdiag <- icd10_9_extractor(hf_diag_tb, 'I50.0|I50.1|I50.9','4280|4281|4289', 'hf')
t2d_hospdiag <- icd10_9_extractor(t2d_diag_tb, 'E11','25000|25010', 't2d')
```

## Use First Occurrence Field

For HF (I50) and T2D (E11), use first occurrence field date ("p131354" "p130708" respectively) to extract the date.

```{r}
hf_tb <- select(hf_diag_tb, ID=eid, firstocc_hf=p131354) %>%
  left_join(hf_selfrep, by='ID')%>%
  left_join(hf_hospdiag, by='ID')%>%
  rowwise() %>%
  mutate(min_diag_date=ifelse(!is.na(firstocc_hf), firstocc_hf, min(selfrep_hf_interpolated_year, icd10_hfdiagdate, icd9_hfdiagdate, na.rm=T))) %>%
  ungroup() %>%
  mutate(min_diag_date=as_date(ifelse(is.infinite(min_diag_date),NA, min_diag_date))) %>%
  select(ID, min_diag_date) %>%
  left_join(attendance_date, by='ID')


t2d_tb <- select(t2d_diag_tb, ID=eid, firstocc_t2d=p130708) %>%
  left_join(t2d_selfrep, by='ID')%>%
  left_join(t2d_hospdiag, by='ID')%>%
  rowwise() %>%
  mutate(min_diag_date=ifelse(!is.na(firstocc_t2d), firstocc_t2d, min(selfrep_t2d_interpolated_year, icd10_t2ddiagdate, icd9_t2ddiagdate, na.rm=T))) %>%
  ungroup() %>%
  mutate(min_diag_date=as_date(ifelse(is.infinite(min_diag_date),NA, min_diag_date))) %>%
  select(ID, min_diag_date) %>%
  left_join(attendance_date, by='ID')
```


## Merger

This merges the self-reported interpolated year with the hospital-diagnosed dates of ICD9/10 diagnoses.

```{r}
hcm_tb <- left_join(hcm_selfrep, hcm_hospdiag, by='ID') %>%
  left_join(attendance_date, by='ID') %>%
    rowwise() %>%
    mutate(min_diag_date = min(c_across(2:4),na.rm=T)) %>% #Assume that columns 2 to 4 are the diagnosis dates (self-reported; ICD10 and ICD9)
    mutate(min_diag_date = as_date(ifelse(is.infinite(min_diag_date),NA,min_diag_date)))

#rm(list=ls(pattern='diag|selfrep'))
```

## I0 Cases

This provides the IDs of the individuals who were diagnosed with their disease prior to their first attendance at the assessment centre (i.e had one of the 3 dates before their initial assessment date).

```{r warnings=F}
i0_extractor <- function(input_tb, output_name, output_folder='../../PROCESSED/'){
  
  output_tb <- input_tb %>%
    mutate(i0_case= ifelse(min_diag_date <= date_attend_i0, T,F))
    
  print(str_c('There are',nrow(filter(output_tb, is.na(min_diag_date))), output_name, 'cases in the UKB who have NA value for diagnosis date', sep=' ' ))
  print(str_c('There are',nrow(filter(output_tb, i0_case==T)), output_name, 'cases in the UKB who were diagnosed with disease prior to instance 0 of attending assessment centre', sep=' ' ))
  
  write_tsv(filter(output_tb, i0_case==T)%>% select(ID), str_c(output_folder, 'ukb_rap_',output_name, '_20240209_i0cases.tsv'))
  
  return(output_tb)
}

i0_tbs <- map2(list(hcm_tb, hf_tb, t2d_tb), list('HCM','HF','T2D'), ~i0_extractor(.x, .y))
```
## 5Y Cases

This provides the IDs of individuals who

1. Were diagnosed with disease prior to first attendance (i0)
2. Were diagnosed with disease within 5 years after first attendance 
3. Died within 5 years after first attendance + have death cause record mention of disease X.

```{r}
death_dates <- read_tsv('../../../../../../HCM_Severity/DATASETS/UKB/RAP/Outcomes/Processed/allukb_outcome_dates.tsv') %>%
  select(ID,death_date)

death_cause_record <- read_tsv('../../../../../../HCM_Severity/DATASETS/UKB/RAP/Outcomes/data_death_cause.tsv')
```


```{r}
#This appends the death date to the input_tb as a column if that individual also has a death cause of the icd10 code of interest
death_date_extractor <- function(input_tb, death_dates, death_cause_tb, icd10_code){
  
  death_indiv_withicd10 <- death_cause_tb %>%
    filter(str_detect(cause_icd10, icd10_code))
  
   print(str_c('There are',nrow(death_indiv_withicd10), 'individuals who provide death cause of', icd10_code, sep=' '))
  
  death_dates_indiv_withicd10 <- death_dates %>%
    filter(ID %in% death_indiv_withicd10$eid)
  
  output_tb <- input_tb %>%
    left_join(death_dates_indiv_withicd10, by='ID')
  
  return(output_tb)
}

#This is the individuals with their diagnosis dates; death dates (if their death cause record mentions ICD10 code of interest) and dates of attendance
i0_death_tbs <- map2(i0_tbs, list('I42.1|I42.2','I50.0|I50.1|I50.9','E11'), 
                   ~death_date_extractor(.x,death_dates, death_cause_record,.y))
```

```{r}
#This extracts and writes out the IDs of patients who satisfy the 5Y criteria
fiveyear_extractor <- function(input_tb, output_name, output_folder='../../PROCESSED/'){
  
  output_tb <- input_tb %>%
    mutate(fiveyear_case = ifelse(time_length(min_diag_date - date_attend_i0, unit='year') <= 5 |  #Assign 5Y status if their minimum date of diagnosis was within 5 years after attendance. NB This includes i0 cases because they have a time_length of negative because min_diag_Date < date_attend_i0
                                    time_length(death_date - date_attend_i0, unit='year') <=5, T,F)) #OR if they had mention of death with ICD10 code of interest & died within 5 years of attendance
    
  print(str_c('There are',nrow(filter(output_tb, fiveyear_case==T)), output_name, 'cases in the UKB who satisfy 5Y criteria', sep=' ' ))
  
  write_tsv(filter(output_tb, fiveyear_case==T)%>% select(ID), str_c(output_folder, 'ukb_rap_',output_name, '_20240209_5Ycases.tsv'))
  
  return(output_tb)
}

i0_5Y_tbs <- map2(i0_death_tbs, list('HCM','HF','T2D'), ~fiveyear_extractor(.x, .y))
saveRDS(i0_5Y_tbs, '../../PROCESSED/ukb_rap_i0_5Y_cases.rds')
```

